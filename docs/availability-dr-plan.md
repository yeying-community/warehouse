# WebDAV 单实例风险评估与可用性/容灾方案（确定版）

> 适用现状：文件数据在本地磁盘、数据库为单机 PostgreSQL。

## 1. 背景与问题

当前为单实例、单副本部署：
- WebDAV 服务宕机即不可用
- 主机或磁盘故障可能导致数据不可恢复

该风险被认定为**不可接受**，需要立刻降低数据丢失概率，并规划高可用演进路线。

## 2. 风险评估（现状）

1) 单点故障  
任何进程、机器、网络或磁盘故障都会导致服务中断。

2) 数据丢失风险  
文件数据仅在本地磁盘；数据库无主备与 WAL 归档，导致不可恢复的可能。

3) 恢复不可控  
缺少备份演练，未知恢复时间与可恢复数据范围。

## 3. 目标（确定）

- **RPO**（可接受数据丢失上限）：<= 15 分钟  
- **RTO**（可接受恢复时间）：<= 30 分钟  
（后续可根据业务规模调整）

## 4. 方案确定（分阶段落地）

### 阶段一：立即止血（1–3 天）
目标：降低“数据不可恢复”风险

- 文件数据异地备份  
  - 每小时增量 + 每日全量  
  - 备份位置不与生产同机（另一台机器或对象存储）

- PostgreSQL 备份 + WAL 归档  
  - 每日全量 + 持续 WAL  
  - 保留 7–30 天  

- 恢复演练（强制要求）  
  - 每月至少 1 次  
  - 验证：数据库恢复 + 文件恢复 + WebDAV 可读写

### 阶段二：可用性提升（1–2 周）
目标：主机宕机后可快速恢复服务

- 计算与存储分离  
  - 文件数据迁移到可复制存储（优先对象存储或高可用 NFS）

- 数据库主备  
  - 至少一主一备，支持故障切换

- WebDAV 双实例 + 负载均衡  
  - 共享存储或对象存储作为后端

### 阶段三：长期可用性与灾备（1–2 个月）
目标：持续可用 + 灾备

- 文件存储切换为对象存储（S3/MinIO）
- PostgreSQL 多可用区或托管高可用
- 明确跨区备份与恢复流程

## 5. 备份与演练要求（确定）

1) 备份频率  
- 文件：每小时增量 + 每日全量  
- 数据库：每日全量 + WAL 归档

2) 备份保留  
- 至少 7 天（建议 30 天）

3) 恢复演练  
- 每月至少 1 次  
- 演练结果需记录：RPO、RTO、问题点与修复动作

## 6. 最小可行落地清单（T0）

**必须完成：**
- 文件数据异地备份任务
- PostgreSQL 备份 + WAL 归档
- 1 次恢复演练

**建议同步完成：**
- 进程自愈（systemd/Docker 重启策略）
- 监控告警（存活、磁盘、错误率）

## 7. 最终决策（确定）

1) 立即执行阶段一，优先保障“数据可恢复”。  
2) 两周内落地阶段二，消除单点故障。  
3) 以对象存储 + 高可用数据库为长期目标。

